<analysis>**original_problem_statement:**
Build a secure, scalable, mobile-first internal operations management application for a spa operations company named Nirvaana Wellness. The system should function as a complete internal Spa Operations ERP, handling property and therapist management, attendance, sales tracking, GST automation, revenue sharing, incentives, monthly settlements, and automated WhatsApp feedback.

**LATEST PRODUCT REQUIREMENTS (Reporting & Profit Calculation):**
- **Core Logic:** Revenue sharing percentages must be applied to the **Base Amount (excluding GST)**, not the gross, GST-inclusive amount.
- **Profit Formula:** Net Profit = Our Base Share â€“ Expenses.
- **Data Separation:** Reports must clearly distinguish between Base Revenue, GST Amount, and Gross Revenue.
- **Settlement Logic:** Must be transparent and auditable, accounting for who collected the base amount and who collected the GST, then reconciling the difference based on contractual shares of the base amount.
- **New Graphs:** A date-wise line graph showing revenue over the selected period, with red 'X' markers on dates with recorded expenses.
- **UI Changes:** The Therapists filter must be removed from the Reports page.
- **Sales Report Columns:** The report must be updated to show a detailed breakdown including Base Revenue, GST, Gross Revenue, Share %, Expected vs. Received amounts for both Hotel and Nirvaana (separating base and GST), and a final settlement amount (To Pay Hotel / To Pay Nirvaana).

**User's preferred language**: English

**what currently exists?**
A full-stack application with a React frontend and FastAPI backend. It features role-based authentication (Admin, Therapist), management modules for properties and therapists, and a service entry form.

A comprehensive, interactive Admin Dashboard and Reports module has been built. Key features include:
- **Admin Dashboard:** A month-scrolling timeline to view data for today, the current month-to-date, or any past month.
- **Reports Page:** A dedicated page with advanced filters (Year, Month, Quarter, Property), summary cards (Gross Revenue, Expenses, Profit), a date-wise revenue line graph with expense markers, and a bar chart comparing properties.
- **Downloadable Reports:** Dialogs for detailed Sales, Expense, and Profit & Loss reports with an Export to Excel feature.
- **Dynamic Logic:** The system uses property-specific revenue sharing percentages for calculations.

**Last working item**:
- **Last item agent was working**: The user provided a critical correction to the financial reporting logic. The current system incorrectly applies revenue sharing percentages to the gross revenue instead of the base revenue (excluding GST). The agent has acknowledged this requirement and was about to begin implementation.
- **Status**: NOT STARTED
- **Agent Testing Done**: N
- **Which testing method agent to use?**: both
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- **Issue 1**: Implement GST-separated financial reporting logic (P0)
- **Issue 2**: Finalize User Management (Admin password change with OTP, Therapist deactivation) (P1)
- **Issue 3**: UI Fix - Remove icon from login page (P2)
- **Issue 4**: Implement a functional SMS backup system for notifications (P3)

**Issues Detail:**
- **Issue 1: Implement GST-separated financial reporting logic (P0)**
    - **Attempted fixes**: None. The user just provided the new requirements.
    - **Next debug checklist**:
        1.  **Backend ():** Modify the reporting API endpoint ( or a new one) to separate  from  in all aggregations. The API response must provide a detailed breakdown for the frontend, including fields like , , , , etc., calculated per property.
        2.  **Frontend ():**
            - Overhaul the data fetching and state management to handle the new API structure.
            - Rebuild the **Sales Report** dialog to display all required columns as per the latest user spec (Base Revenue, GST, Gross, Share %, Expected/Received breakdowns, Settlement Amount).
            - Update the **P&L Report** dialog to calculate profit as .
            - Correct the main summary cards on the Reports page to use the new GST-aware calculations.
    - **Why fix this issue and what will be achieved with the fix?**: This is a critical accounting requirement. The current financial reports are inaccurate and not compliant with the business model, which can lead to incorrect settlements and tax issues.
    - **Status**: NOT STARTED
    - **Is recurring issue?**: N
    - **Should Test frontend/backend/both after fix?**: both

- **Issue 2: Finalize User Management (P1)**
    - **Attempted fixes**: None.
    - **Next debug checklist**:
        1.  Implement an OTP-based change password feature for the admin user.
        2.  Add a  field (e.g., 'active', 'inactive') to the  model to handle therapist deactivation properly.
    - **Why fix this issue and what will be achieved with the fix?**: To enhance security and provide complete user lifecycle management.
    - **Status**: NOT STARTED
    - **Is recurring issue?**: N
    - **Should Test frontend/backend/both after fix?**: both

- **Issue 3: UI Fix - Remove icon from login page (P2)**
    - **Attempted fixes**: The agent changed the text on the login page but forgot to remove the icon above it.
    - **Next debug checklist**: Edit  and remove the JSX element for the icon.
    - **Why fix this issue and what will be achieved with the fix?**: To match the user's specific UI request.
    - **Status**: NOT STARTED
    - **Is recurring issue?**: N
    - **Should Test frontend/backend/both after fix?**: frontend

**In progress Task List**:
- **Task 1: Complete Reporting & Dashboard Module Overhaul**
    - **Where to resume**: The entire reporting feature, primarily in  and the backend logic in , needs to be refactored to implement the GST-separated accounting logic.
    - **What will be achieved with this?**: A financially accurate, auditable, and compliant reporting system that matches the user's business requirements.
    - **Status**: IN PROGRESS
    - **Should Test frontend/backend/both after fix?**: both

**Upcoming and Future Tasks**
- **Upcoming Tasks**:
    - **(P1)** Implement a full analytics dashboard with more graphs (Sales Trends, Pie Charts).
- **Future Tasks**:
    - **(P2)** Implement the automated monthly closing system to lock records.
    - **(P3)** Implement the optional feature to email therapist ID proofs/photos to .

**Completed work in this session**
- **Dashboard & Reporting Overhaul**:
    - Created a new  with a month-scrolling timeline for date selection.
    - Created a new  page with advanced filters, summary cards, and two new graphs (date-wise revenue line graph with expense markers, property-wise bar chart).
    - Implemented three detailed, downloadable report dialogs for Sales, Expenses, and P&L.
    - Implemented logic for dynamic, property-specific revenue sharing.
    - Refined the Sales Report to show To Pay Hotel and To Pay Nirvaana columns.
- **Expense Tracking (Partial)**: Added a basic  model, CRUD API endpoints, and a simple UI page ().
- **UI Fix**: Changed the text on the  page to Nirvaana Wellness.

**Earlier issues found/mentioned but not fixed**
- **Admin Password Change**: The request to add an OTP-based password change for the admin has not been addressed.
- **Login Page Icon**: The user requested removing an icon from the login page, which was missed.

**Known issue recurrence from previous fork**
- None.

**Code Architecture**


**Key Technical Concepts**
- **Frontend**: React, Tailwind CSS, shadcn/ui, Recharts
- **Backend**: FastAPI, Pydantic
- **Database**: MongoDB
- **Authentication**: JWT (JSON Web Tokens)
- **Integrations**: Resend (Email API)

**key DB schema**
- **User**: {email, hashed_password, role, full_name, phone_number, assigned_property, salary, etc.}
- **Property**: {hotel_name, location, gst_number, revenue_share: float, etc.}
- **Service**: {customer_name, therapy_name, base_price, gst_amount, total_amount, therapist_id, property_id, etc.}
- **Expense**: {property_id, expense_type, description, amount, date}

**changes in tech stack**
- None.

**All files of reference**
- : Contains all API logic. Needs a major update for reporting.
- : The main reporting component. Needs a complete logic overhaul.
- : The main dashboard component.
- : Needs a minor UI fix (icon removal).
- : Defines initial data, including property revenue share percentages.

**Areas that need refactoring**:
-  is a monolithic component handling complex data fetching, filtering, state management, multiple graphs, and modal dialogs. It should be broken down into smaller, manageable components and custom hooks (e.g., , , ).

**key api endpoints**
- 
- 
- 
- : Heavily used by the reporting module; its logic needs to be rewritten.
- : New endpoints for managing expenses.

**Critical Info for New Agent**
- **The current financial reporting logic is fundamentally wrong.** The immediate priority is to refactor the backend and frontend () to separate GST from the base revenue before applying revenue share percentages, as detailed in the latest user requirements.
- Do not trust the financial figures currently displayed in the UI. They are calculated incorrectly.
- The user has provided very specific, detailed requirements for the new accounting logic and report layout. Follow them precisely.
- The  passed previously, but it was validating the *incorrect* logic. The tests themselves will need to be updated or rewritten once the new logic is in place.

**documents and test reports created in this job**
-  (updated)
-  (Note: This report validated incorrect logic and is now outdated).

**Last 10 User Messages and any pending HUMAN messages**
1. **User:** Provided detailed new requirements for a dashboard overhaul and a comprehensive reporting module (month timeline, filters, downloadable reports).
2. **Agent:** Acknowledged and began implementing the new dashboard and reports page.
3. **Agent:** Created the new  and  files.
4. **Agent:** Took screenshots, noticed a bug in the month timeline, and fixed it.
5. **Agent:** Fixed a runtime error on the  page.
6. **Agent:** Verified the complete UI for the new Dashboard and Reports pages, including filters, graphs, and report dialogs.
7. **Agent:** Ran the , which passed all tests, and prepared to finish.
8. **User:** Intervened with a critical correction: the profit calculation is wrong. Provided a detailed spec on how to correctly calculate profit based on dynamic revenue shares and property-specific logic. Introduced new requirements for a date-wise line graph with expense markers and the removal of the Therapists filter.
9. **Agent:** Acknowledged the critical update and rewrote  to implement the new profit formula and UI changes.
10. **User:** Provided another detailed clarification for the Sales Report, specifying how settlement should work (To be Paid to Hotel vs. To be Paid to Nirvaana).
11. **Agent:** Acknowledged and updated the Sales Report dialog and CSV export to match the new column structure.
12. **User (LATEST):** Provided the final, critical business logic correction: **revenue share must be applied on the Base Amount (excluding GST)**. The current system applies it on the gross amount. This invalidates all current financial calculations and requires a major refactor.

**Project Health Check:**
- **Broken**: The entire financial reporting and settlement logic is incorrect as it does not separate GST from base revenue before calculations.
- **Mocked**: WhatsApp & SMS notifications remain non-functional placeholders.

**3rd Party Integrations**
- **Resend**: Used for transactional emails (therapist onboarding). Requires a User API Key.
- **WhatsApp Business API** (Planned)
- **SMS Gateway** (Planned)

**Testing status**
- **Testing agent used after significant changes**: YES, but it validated incorrect business logic and is now outdated.
- **Troubleshoot agent used after agent stuck in loop**: NO
- **Test files created**: []
- **Known regressions**: The entire reporting feature, while visually complete, is logically incorrect and needs a full rework of its calculation engine.

**Credentials to test flow:**
- **Admin**: Email: , Password: 
- **Therapist**: Email: , Password: 

**What agent forgot to execute**
- The agent implemented multiple complex reporting features without first clarifying the core business logic around GST, leading to the current need for a major rework.
- The agent forgot to remove the small icon on the  page as requested by the user.
- The agent did not implement the OTP-based password change feature for the admin user.</analysis>
